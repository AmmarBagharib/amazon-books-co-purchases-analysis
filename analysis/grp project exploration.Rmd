---
title: "Group Project (exploration)"
author: "Chen Yang"
date: "2023-09-15"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(tidyr)
library(igraph)
library(data.table)
library(glue)
library(gridExtra)
library(ggplot2)
library(glue)
library(stringr)
```


```{r metadata}
#read metadata txt
meta <- readLines("../data/amazon-meta.txt")
#exclude blanks, reviews, actor/actress info so that we deal with less data
meta <- meta[meta != "" & !grepl("^\\s*\\d+-\\d+-\\d+\\s*cutomer:\\s*[A-Za-z0-9]+", meta) & !grepl("\\|Actors & Actresses\\[\\d+\\]\\|[^|]*", meta)]

#define regex pattern and identify item id, start/stop index for each item
pattern <- "^\\s*[iI]+\\s*[dD]+\\s*:+\\s*\\d+$"
start_ind <- which(grepl(pattern, meta))
stop_ind <- c(start_ind[2:length(start_ind)]-1, length(meta))

#function to handle empty ID matches
conditional_fn <- function(x) {
  ifelse(length(x) == 0, NA, x)
}

#get item ids with regex
item_id <- meta[start_ind] %>% regmatches(., gregexpr("\\d+", .)) %>% lapply(., conditional_fn) %>% unlist()


#compile into dataframe
item_index <- data.frame(id = item_id, start = start_ind, stop = stop_ind, length = stop_ind - start_ind + 1)

#get product type
grp_pattern <- "group:\\s*(.+)"
product_type <- c()

for (i in 1:length(item_index %>% row.names())) {
  test_item <- meta[item_index$start[i]:item_index$stop[i]]
  type <- test_item %>% .[grep(grp_pattern, .)] %>% str_match(., grp_pattern) %>% .[2]
  product_type <- c(product_type, type)
}

item_index$type <- product_type

#view distribution of attribute length
item_index %>% group_by(length) %>% summarize(n = n())

#save
#write.csv(item_index, "item_index.csv", row.names = FALSE)
```


```{r preview}
item_index %>% group_by(type) %>% summarise(n = n()) %>% arrange(desc(n))
```


```{r test_regex_pattern}
test_str <- "    2002-12-9  cutomer:  AWHX6ZSA0UKMF  rating: 4  votes:   2  helpful:   2" 
test_str %>% grepl("^\\s*\\d+-\\d+-\\d+\\s*cutomer:\\s*[A-Za-z0-9]+", .)
```

```{r read_graph_data}
set.seed(123)
df <- read.table('Amazon0302.txt')
g1 <- graph_from_data_frame(df, directed = TRUE)
```

```{r deg_visualization}
in_deg = degree(g1, mode = "in")
in_deg = data.frame(deg = in_deg)

ggplot(in_deg, aes(x = deg)) +
  geom_histogram(bins = 20) +
  scale_y_continuous(trans = "log10", breaks = c(1, 10, 100, 1000, 100000)) +
  labs(y = 'freq (log10)', x = 'in degree')
```

```{r sampling}
in_deg <- in_deg %>% mutate(bin = cut(deg, breaks = 100, labels = FALSE))

sampled_df <- in_deg %>%
  group_by(bin) %>%
  sample_frac(0.0001, replace = FALSE) %>%
  ungroup()

#get subgraph from sampled vertices
subg <- induced_subgraph(g1, row.names(sampled_df))

#get largest component
comps <- clusters(subg)
largest_comp_ind <- which.max(comps$csize)
largest_comp_vert <- which(comps$membership == largest_comp_ind)

plot(induced_subgraph(g1, largest_comp_vert), layout = layout.fruchterman.reingold(subg))
``
