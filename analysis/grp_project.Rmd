---
title: "Group Project (exploration)"
author: "group"
date: "2023-09-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(dplyr)
library(tidyr)
library(igraph)
library(data.table)
library(glue)
library(gridExtra)
library(ggplot2)
library(stringr)
library(here)
```

```{r , setup, include=FALSE}
#set working directory to project root folder
knitr::opts_knit$set(root.dir = here())
```

**Project Background**

Established in 1995 as a pioneering online bookstore, Amazon has been a cherished destination for book enthusiasts for several decades. While the company has evolved and expanded into a diverse range of industries, it has consistently maintained its status as a go-to hub for book shoppers.

In the scope of this project, our objective is to delve into the evolving co-purchase patterns of books over time, understand it's characteristics and underlying patterns. With these information, we'll then develop a model that can provide personalized book recommendations based on books which the customer has added to his/her basket.

In doing so, we anticipate that our efforts will yield a mutually beneficial outcome. By facilitating book discoveries and guiding readers to titles they might not have encountered otherwise, we aim to stimulate sales on the platform, benefiting both Amazon and its thriving community of book lovers.

**1. Network Characteristics**

```{r read_data}
set.seed(123)

# Read the graph from the GraphML file
g <- read_graph(here("outputs/filtered_graph.graphml"), format = "graphml")
# read filtered book data
books_df <- read.csv(here("outputs/book_filtered.csv"))
# changing id column from 'int' to 'chr' dtype
books_df$id <- as.character(books_df$id)

g

head(books_df)
```



```{r node_attributes}

# store attributes into a data.frame
node_attributes_df=data.frame(vertex_id=V(g)$name, 
                              degree = degree(g, mode = "all"),
                              in_degree=degree(g, mode = "in"), # adding the vertex level attributes
                              out_degree = degree(g, mode = "out"),
                              closeness=closeness(g, mode='all'),
                              betweenness=betweenness(g, directed=TRUE),
                              transitivity=transitivity(g, type = "local"), # There are many NaN transitivity values; it means these nodes are isolated?
                              eigen_centrality = eigen_centrality(g)$vector,
                              page_rank = page_rank(g)$vector,
                              component_membership = components(g)$membership) #should we specify weakly or strongly connected component?


head(node_attributes_df)
```

```{r merging_node_attributes_books_df}
merged_df = books_df %>% left_join(node_attributes_df, by = c("id" = "vertex_id"))
head(merged_df)
```

**2.1. Degree Centrality**

In our directed graph, out-degree represents the number of books that the focal book is co-purchased with, indicating the tendency of a given book to be purchased together with other books. On the other hand, in-degree represents the number of books that are co-purchased with the focal book, meaning it shows how many other books are influenced by the purchase of the focal book. In short, books with high out-degree centrality are frequently co-purchased with other books, suggesting that they are influenced by a wide range of other books, while books with high in-degree centrality are often the ones that influence the purchase of other books.

From the graphs, we can see that the network's degree distribution follows the power-law, which is a characteristic of naturally-occurring graphs; most books have low degree centrality of 3 and below. In-degree distribution looks very similar to that of all-degree, with most books having 3 or fewer in-bound links. To the most extreme right, there are a small number of books with 12 in-bound links, indicating that they have a very high degree of influence on the purchase of other books. On the other hand, out-degree distribution is much more left-skewed than in-degree, with most books having either 0 or 1 out-bound links. In the most extreme cases, a small number of books have 3 outbound-links. 

In conclusion, low in-degree, along with the low out-degree, suggests that most books in the network are not strongly influencing the purchase of other products, nor are they strongly influenced by other products. However, we can investigate the outliers with high in-degree centrality to better understand how we can formulate cross-selling strategies to improve co-purchase tendencies.

```{r deg_visualization, fig.width=15, fig.height=5}
#function to plot histogram
plot_hist <- function(g, title, x_label, y_label, log_scale = FALSE) {
  labels <- labs(y = y_label, x = x_label, title = title)  # Added title parameter
  graph <- ggplot() + geom_histogram(aes(x = g), bins = 10) + labels
  
  if (log_scale == TRUE) {
    return(graph + ls)
  } else {
    return(graph)
  }
}

#calculate in, out and all degree centrality for each graph
deg <- degree(g, mode = "all")
deg_in <- degree(g, mode = "all")
deg_out <- degree(g, mode = "out")

#visualize
all_deg <- plot_hist(deg, "degree distribution for 0302", "degree", "frequency")
in_deg <- plot_hist(deg_in, "in-degree distribution for 0302", "degree", "frequency")
out_deg <-plot_hist(deg_out, "out-degree distribution for 0302", "degree", "frequency")
grid.arrange(all_deg, in_deg, out_deg, ncol = 3)
```

**2.2. Degree Centrality**
The low network density of 0.000299 in the network indicates that, relative to the total possible connections between books, there are very few actual co-purchases. This suggests that the network is quite sparse, with a limited number of co-purchases taking place.

Global transitivity measures how likely the neighbors of two connected nodes are connected to each other. In the case of our co-purchase network, it measures the likelihood that the alters of two books which are co-purchased together are also co-purchased with each other. The moderate global transitivity value of 0.242 tells us that there is a noteworthy degree of clustering or transitivity within this sparse network. 

This means that, despite the overall sparsity, there is a tendency for co-purchased books to have shared co-purchases with other books in the network. In simpler terms, when two books are co-purchased together, there is a relatively higher likelihood that other books co-purchased with those two are also co-purchased with each other. 

In summary, it suggests that there are distinct co-purchase patterns or niche markets within the network. Products within these clusters frequently co-purchase with each other, even if the overall network is not densely interconnected.

```{r graph-attributes}
global_transitivity = transitivity(g, type="global")
density = graph.density(g)
print(paste("The global transitivity of the graph is", global_transitivity, "and the graph density is", density))
```

# Clusters

```{r component, fig.width = 15, fig.height = 10}
#get largest component
comps <- clusters(g)
largest_comp_ind <- which.max(comps$csize)
largest_comp_vert <- which(comps$membership == largest_comp_ind)
largest_comp_subg <- induced_subgraph(g, largest_comp_vert)

#visualize largest component
plot(largest_comp_subg, layout = layout.fruchterman.reingold(g), vertex.size = degree(largest_comp_subg))
#degree distribution for sampled graph
plot_hist(degree(g), "Degree Centrality distribution for sampled graph", "degree centrality", "frequency", log_scale = FALSE)
#degree distribution for largest component
plot_hist(degree(largest_comp_subg), "Degree Centrality distribution for largest component", "degree centrality", "frequency", log_scale = FALSE)
```


# Clustering

Source Codes

https://cran.r-project.org/web/packages/linkprediction/linkprediction.pdf

https://rpubs.com/writetosamadalvi/CommunityDetection

https://users.dimi.uniud.it/~massimo.franceschet/R/communities.html

https://rstudio-pubs-static.s3.amazonaws.com/734940_93adb495f0e34ca291fcda1d214129d1.html#Service_as_a_Freelancer









